# Telegram-бот для контроля сотрудников

Telegram-бот для архитектурного бюро, который помогает руководителю контролировать активность сотрудников и фиксировать их формат работы.

## Установка

1. Создайте виртуальное окружение:
```bash
python3 -m venv .venv
```

2. Активируйте виртуальное окружение:

**macOS/Linux:**
```bash
source .venv/bin/activate
```

**Windows:**
```bash
.venv\Scripts\activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте файл `.env` и добавьте токен вашего бота:
```
BOT_TOKEN=ваш_токен_от_BotFather
```

## Запуск

Убедитесь, что виртуальное окружение активировано, затем:

```bash
python -m bot.main
```

## Тестирование

### Запуск автотестов

После установки зависимостей вы можете запустить автотесты:

**macOS/Linux:**
```bash
./run_tests.sh
```

**Windows:**
```bash
run_tests.bat
```

**Или напрямую через pytest:**
```bash
pytest
```

**С покрытием кода:**
```bash
pytest --cov=bot --cov-report=term-missing --cov-report=html
```

Отчёт о покрытии будет сохранён в `htmlcov/index.html` (откройте в браузере).

### Автоматический запуск тестов перед коммитом

Для автоматического запуска тестов перед каждым коммитом установите pre-commit hooks:

```bash
pip install pre-commit
pre-commit install
```

Теперь тесты будут запускаться автоматически перед каждым коммитом. Если тесты не пройдут, коммит будет отменён.

### Ручное тестирование бота

После запуска бота:
1. Найдите вашего бота в Telegram
2. Отправьте команду `/start`
3. Бот должен ответить приветственным сообщением

### Проверка утренней рассылки

Для проверки автоматических рассылок можно временно изменить время рассылки:

1. **Временно изменить время рассылки:**
   - Откройте файл `.env` и добавьте (или измените) переменную:
     ```
     MORNING_BROADCAST_TIME=14:30
     ```
     (Установите время на несколько минут позже текущего времени для быстрой проверки)
   - **Важно:** После изменения `.env` файла необходимо перезапустить бота, чтобы настройки обновились в базе данных

2. **Убедитесь, что есть активные пользователи с согласием:**
   - В базе данных должны быть пользователи с `active_flag = 1` и `consent_given = 1`
   - Проверить можно через SQLite:
     ```bash
     sqlite3 bot_data.db "SELECT tg_id, username, active_flag, consent_given FROM users WHERE active_flag = 1 AND consent_given = 1;"
     ```

3. **Запустите бота:**
   ```bash
   python -m bot.main
   ```

4. **Проверьте логи:**
   - При запуске должны появиться сообщения:
     ```
     Запланирована утренняя рассылка на 14:30
     Планировщик запущен
     ```
   - В указанное время (14:30) должны появиться логи:
     ```
     Отправка утреннего напоминания пользователю <tg_id>
     ```

5. **Проверьте получение сообщений:**
   - Активные пользователи с согласием должны получить сообщение:
     ```
     Доброе утро! Пожалуйста, отметьте формат работы на сегодня.
     ```
     с клавиатурой выбора формата работы

6. **Верните нормальное время:**
   - После проверки верните в `.env`:
     ```
     MORNING_BROADCAST_TIME=08:00
     ```
   - Или удалите переменную, чтобы использовалось значение по умолчанию

**Примечание:** Время рассылок хранится в таблице `settings` базы данных. При изменении переменной окружения и перезапуске бота настройки обновятся автоматически.

## Структура проекта

```
plotinka_employeers_control_bot/
├── bot/                    # Основной код бота
│   ├── main.py            # Точка входа
│   ├── config.py          # Конфигурация
│   ├── handlers/          # Обработчики команд
│   └── utils/             # Утилиты
├── tests/                 # Тесты
├── docs/                  # Документация
└── requirements.txt       # Зависимости
```

## Документация

- [Идея проекта](docs/idea.md)
- [Видение проекта](docs/vision.md)
- [Правила разработки](docs/conventions.md)
- [План разработки](docs/tasklist.md)
- [Workflow разработки](docs/workflow.md)
